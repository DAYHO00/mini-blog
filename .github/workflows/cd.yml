name: CD

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

    steps:
      - name: Deploy via SSH to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            cd /home/ubuntu/mini-blog
            git fetch --all
            git reset --hard origin/main

            cd infra

            # 1) frontend는 local 이미지라 pull하면 실패함 → db/backend만 pull
            docker compose -f docker-compose.prod.yml pull db backend

            # 2) backend만 최신 이미지로 교체(강제 재생성)
            docker compose -f docker-compose.prod.yml up -d --no-deps --force-recreate backend

            # 3) 전체 상태 정리(이미 떠있는 frontend/db는 그대로 유지됨)
            docker compose -f docker-compose.prod.yml up -d

            docker compose -f docker-compose.prod.yml ps
